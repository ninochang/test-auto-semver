name: auto-tag

on:
  push:

concurrency:
  group: nino-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  auto-tag:
    runs-on: ubuntu-latest
    env:
      GPG_SECRET_KEY_BIN: ${{ secrets.GPG_SECRET_KEY_BIN }}
      GPG_PUBLIC_KEY_BIN: ${{ secrets.GPG_PUBLIC_KEY_BIN }}
    steps:
    # - name: 
    #   run: |
    #     echo hello $GPG_SECRET_KEY
    - uses: actions/checkout@v2
    - name: Auto tag
      run: |
        # import private/public key
        echo -n $GPG_PUBLIC_KEY_BIN | base64 --decode | gpg --import
        echo -n $GPG_SECRET_KEY_BIN | base64 --decode | gpg --import

        now=$(date +"%s")

        # setup git
        git config --global user.email nino.chang@swag.live
        git config --global user.name "ninochang"
        git config --global user.signingkey 94C68424484812EC
        git tag -f -s "tag-$now" -m "tag-$now-payload"
        git push -f --tag

        # info=$(gh api /repos/${{ github.repository }}/commits/${{ github.sha }} | jq "{email:.commit.committer.email, verified: .verification.verified }")
        # verified=$(echo $info | jq .verified)
        # commiter_email=$(echo $info | jq .email)

        # for i in "${($GITHUB_TAGGER)[@]}"
        # do
        #   if [[ $i == $commiter_email ]]; then
        #     git tag -f -s TAG_NAME
        #     git push --tag
        #   break
        #   fi
        # done
